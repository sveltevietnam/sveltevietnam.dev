# based on https://github.com/umami-software/umami/blob/master/docker-compose.yml
# extended with a redis cache
---
services:
  umami:
    image: ghcr.io/umami-software/umami:postgresql-latest
    container_name: umami
    ports:
      - '3000:3000'
    environment:
      DATABASE_URL: postgresql://<username>:<password>@db:5432/<database>
      DATABASE_TYPE: postgresql
      APP_SECRET: <your_app_secret>
      REDIS_URL: redis://cache:6379
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_healthy
    init: true
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'curl http://localhost:3000/api/heartbeat']
      interval: 5s
      timeout: 5s
      retries: 5
  db:
    image: postgres:15-alpine
    container_name: umami-db
    ports:
      - '5432:5432'
    environment:
      POSTGRES_DB: <database>
      POSTGRES_USER: <username>
      POSTGRES_PASSWORD: <password>
    volumes:
      - umami-db-data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}']
      interval: 5s
      timeout: 5s
      retries: 5
  cache:
    image: redis:8-alpine
    container_name: umami-cache
    ports:
      - '6379:6379'
    volumes:
      - umami-cache-data:/data
    restart: always
    healthcheck:
      # test: [ "CMD", "redis-cli", "--raw", "incr", "ping" ]
      test: ['CMD-SHELL', 'redis-cli --raw incr ping']
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  umami-db-data:
  umami-cache-data:
